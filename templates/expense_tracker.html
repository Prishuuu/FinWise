{% extends 'base.html' %}
{% block title %}Expense Tracker - FinWise{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4 text-primary fw-bold">ðŸ“Š Expense Tracker & Visualization</h2>

  <p class="text-center mb-5 text-secondary fst-italic">
    Enter your monthly expenses by category and see a visual breakdown of where your money goes.
  </p>

  <!-- Expense Entry Form -->
  <form id="expense-form" class="row g-3 justify-content-center mb-5">
    <div class="col-md-4">
      <input type="text" id="category" class="form-control" placeholder="Expense Category (e.g. Food)" required>
    </div>
    <div class="col-md-4">
      <input type="number" id="amount" class="form-control" placeholder="Amount (â‚¹)" min="0" step="0.01" required>
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-success">Add Expense</button>
    </div>
  </form>

  <!-- Expense List Table -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Category</th>
          <th>Amount (â‚¹)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="expense-list">
        <!-- Dynamically populated -->
      </tbody>
    </table>
  </div>

  <!-- Chart Container -->
  <div class="card shadow-sm p-3">
    <canvas id="expenseChart" style="max-height: 400px;"></canvas>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const expenseForm = document.getElementById('expense-form');
  const expenseList = document.getElementById('expense-list');
  const ctx = document.getElementById('expenseChart').getContext('2d');

  let expenses = [];

  // Initialize chart
  let expenseChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        label: 'Expenses',
        data: [],
        backgroundColor: [],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { enabled: true }
      }
    }
  });

  // Utility to generate random pastel colors
  function randomColor() {
    const r = Math.floor(Math.random() * 127 + 127);
    const g = Math.floor(Math.random() * 127 + 127);
    const b = Math.floor(Math.random() * 127 + 127);
    return `rgba(${r},${g},${b},0.7)`;
  }

  // Update chart with current expenses
  function updateChart() {
    const labels = expenses.map(e => e.category);
    const data = expenses.map(e => e.amount);
    const bgColors = labels.map(() => randomColor());

    expenseChart.data.labels = labels;
    expenseChart.data.datasets[0].data = data;
    expenseChart.data.datasets[0].backgroundColor = bgColors;
    expenseChart.update();
  }

  // Render expense list in table
  function renderList() {
    expenseList.innerHTML = '';
    expenses.forEach((expense, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${expense.category}</td>
        <td>â‚¹ ${expense.amount.toFixed(2)}</td>
        <td><button class="btn btn-sm btn-danger" data-index="${index}">Remove</button></td>
      `;
      expenseList.appendChild(tr);
    });
  }

  // Add expense handler
  expenseForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const category = document.getElementById('category').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);

    if (category && amount > 0) {
      // If category exists, sum amounts
      const existingIndex = expenses.findIndex(exp => exp.category.toLowerCase() === category.toLowerCase());
      if (existingIndex >= 0) {
        expenses[existingIndex].amount += amount;
      } else {
        expenses.push({ category, amount });
      }
      expenseForm.reset();
      renderList();
      updateChart();
    }
  });

  // Remove expense handler
  expenseList.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON') {
      const index = e.target.getAttribute('data-index');
      expenses.splice(index, 1);
      renderList();
      updateChart();
    }
  });

</script>

{% endblock %}
